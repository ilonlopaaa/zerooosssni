name: RDP via ZeroTier

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 60  # Test dulu 1 jam

    steps:
    # 1. INSTALL ZEROTIER DENGAN WAIT
    - name: Install ZeroTier
      run: |
        echo "ðŸ“¦ Downloading ZeroTier..."
        $url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
        $output = "C:\zt.msi"
        
        # Download
        curl.exe -L $url -o $output
        
        echo "Installing ZeroTier (silent)..."
        # Install dengan wait
        Start-Process msiexec.exe -Wait -ArgumentList "/i", "`"$output`"", "/quiet", "/norestart" -NoNewWindow
        
        echo "Waiting for installation to complete..."
        # Tunggu LAMA (30 detik) biar service jalan
        Start-Sleep -Seconds 30
        
        # Cek apakah ZeroTier installed
        if (Test-Path "C:\Program Files (x86)\ZeroTier\One\zerotier-one_x64.exe") {
            echo "âœ… ZeroTier installed successfully"
        } else {
            echo "âŒ ZeroTier not found at expected path"
            # Coba alternate path
            dir "C:\Program Files*\ZeroTier*" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
        }
        
    # 2. JOIN NETWORK (FIXED PATH)
    - name: Join ZeroTier Network
      run: |
        echo "ðŸ”— Joining ZeroTier network..."
        
        # ======== GANTI INI! ========
        $NETWORK_ID = "a1b2c3d4e5"  # GANTI DENGAN NETWORK ID KAMU!
        # ============================
        
        # Cari executable ZeroTier (bisa beda path)
        $zerotierPaths = @(
            "C:\Program Files (x86)\ZeroTier\One\zerotier-one_x64.exe",
            "C:\Program Files\ZeroTier\One\zerotier-one_x64.exe",
            "${env:ProgramFiles(x86)}\ZeroTier\One\zerotier-one_x64.exe"
        )
        
        $ztExe = $null
        foreach ($path in $zerotierPaths) {
            if (Test-Path $path) {
                $ztExe = $path
                echo "Found ZeroTier at: $ztExe"
                break
            }
        }
        
        if (-not $ztExe) {
            echo "âŒ ZeroTier executable not found. Trying to locate..."
            # Cari semua file zerotier*.exe
            Get-ChildItem "C:\" -Recurse -Filter "zerotier*.exe" -ErrorAction SilentlyContinue | Select-Object FullName
            exit 1
        }
        
        # Join network
        echo "Joining network: $NETWORK_ID"
        & $ztExe join $NETWORK_ID
        
        # Tunggu dan cek status
        echo "Waiting for connection..."
        $connected = $false
        for ($i = 1; $i -le 40; $i++) {
            try {
                $status = & $ztExe info 2>$null
                if ($status -and $status -match "ONLINE") {
                    echo "âœ… ZeroTier connected! (Attempt $i)"
                    $connected = $true
                    break
                }
            } catch {
                # Ignore error
            }
            echo "â³ Waiting... ($i/40)"
            Start-Sleep -Seconds 2
        }
        
        if (-not $connected) {
            echo "âš ï¸ ZeroTier not online yet, but continuing..."
        }
        
        # Dapatkan IP (coba beberapa kali)
        $ztIp = $null
        for ($j = 1; $j -le 10; $j++) {
            try {
                $networks = & $ztExe listnetworks 2>$null
                if ($networks -match '([0-9]{1,3}\.){3}[0-9]{1,3}') {
                    $ztIp = $matches[0]
                    break
                }
            } catch {
                # Ignore
            }
            Start-Sleep -Seconds 3
        }
        
        if ($ztIp) {
            echo "ðŸŒ ZeroTier IP: $ztIp"
            echo "ZEROTIER_IP=$ztIp" >> $env:GITHUB_ENV
        } else {
            echo "âš ï¸ Could not get IP yet. Check ZeroTier admin to auth device."
            echo "ZEROTIER_IP=PENDING_AUTH" >> $env:GITHUB_ENV
        }
        
    # 3. SETUP RDP (SIMPLE)
    - name: Setup RDP
      run: |
        echo "ðŸ–¥ï¸ Setting up RDP..."
        
        # Enable RDP
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        
        # Firewall
        netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
        
        echo "âœ… RDP enabled"
        
    # 4. CREATE USER
    - name: Create User
      run: |
        echo "ðŸ‘¤ Creating user..."
        
        net user rdpzt "Pass123!" /add /Y
        net localgroup administrators rdpzt /add
        net localgroup "Remote Desktop Users" rdpzt /add
        
        echo "RDP_USER=rdpzt" >> $env:GITHUB_ENV
        echo "RDP_PASS=Pass123!" >> $env:GITHUB_ENV
        echo "âœ… User created"
        
    # 5. SHOW INFO
    - name: Display Info
      run: |
        echo ""
        echo "========================================"
        echo "ðŸŸ¢ RDP VIA ZEROTIER"
        echo "========================================"
        echo "ZEROTIER IP: $env:ZEROTIER_IP"
        echo "RDP: $env:ZEROTIER_IP:3389"
        echo "USER: $env:RDP_USER"
        echo "PASS: $env:RDP_PASS"
        echo "========================================"
        echo "ðŸ‘‰ Buka my.zerotier.com"
        echo "ðŸ‘‰ Auth device baru"
        echo "ðŸ‘‰ Tunggu 1-2 menit"
        echo "ðŸ‘‰ Connect RDP"
        echo "========================================"
        
        # Keep workflow alive 55 menit
        $counter = 0
        while ($counter -lt 55) {
            Start-Sleep -Seconds 60
            $counter++
            $remaining = 55 - $counter
            echo "[$(Get-Date)] Still alive... $remaining minutes left"
        }
